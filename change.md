# 0. 先定位你现在为什么会简单（关键矛盾）

你在 `steps.py` 和 `final.py` 里反复写了：

* `参考信息(仅供内部推理，不得在题干中提到)`（Stage2/3/Extend/Final 都有）

这会产生一个必然结果：

1. 你要求“跨模态桥接”，但
2. 求解器只看 `image + question`，
3. 你又禁止把参考信息中的阈值/公式/判据 **改写进题干** ，
   → 那跨模态就只能“在模型内心发生”，题干端没桥，最终只能出“看图就能选”的题，难度当然低。

 **修复原则** ：

> 参考信息不能以“引用/查阅”的方式出现在题干里，但必须允许把其中的 1–2 条关键事实**改写成中性条件/判据**写进题干（不提来源），这样求解端才真的需要“图上读数 + 题干条件”两者结合。

---

## 1) 第一部分：改 Prompt 契约（最关键，必须改）

### 1.1 全局改动目标

把所有 prompt 里的这句：

> “参考信息仅供内部推理，不得在题干中提到”

改为：

> **“参考信息仅供内部推理；允许将其中 1–2 条事实改写为题干的中性条件/阈值/公式（不得提及来源，不得出现‘文献/文档/上下文’等字样）。”**

并新增一个硬约束：

> **“本步必须把 `fact_hint` 改写成题干里的【已知条件】或【判据】（至少 1 条），否则视为失败。”**

---

### 1.2 具体改动（建议直接 patch）

#### A) `steps.py`：Stage2/3/Extend 的 prompt 里增加“必须落地 fact_hint 为题干条件”

把 Stage2/Stage3/Extend 里的约束段落加一条（同样加到 revise prompt）：

```diff
- - 新问题必须使用新的关键信息: {fact_hint}
+ - 新问题必须使用新的关键信息: {fact_hint}
+ - 你必须将 fact_hint 改写为题干中的【已知条件/判据/公式/参数】(至少1条)。
+   注意：可以写数值/阈值/公式，但禁止提“来源/文献/上下文/参考信息”。
```

再把末尾的参考信息提示改掉（Stage2/3/Extend 都改）：

```diff
- 参考信息(仅供内部推理，不得在题干中提到):
+ 参考信息(仅供内部推理；允许将其中1-2条事实改写为题干的中性条件/阈值/公式，不得提及来源):
  {context.strip()}
```

#### B) `final.py`：Final compress 必须“含 2 条中性条件 + 2 步计算/分支”

在 `build_final_compress_prompt` 的要求区新增两条硬约束：

```diff
+ - 题干必须显式包含至少2条【中性条件/判据/公式】（来自 steps 的 evidence/fact_hint 改写，不提来源）。
+ - 题目必须至少包含2步推理：例如(先由图读X→计算Y→再对照判据分级)，或(先判分支→再计算/比较)。
```

并把参考信息那句同样改成“允许改写进题干但不提来源”。

---

### 1.3 “去词汇化”要稍微改口，否则会阻碍可操作难题

你现在写的“题干不要直接写出图中读数…具体值”是对的；
但你同时又要求“条件计算题”，那就必须允许 **把参考信息的阈值/公式写进题干** ，否则计算题不可落地。

所以建议将“去词汇化”明确为：

* ✅ 不要直接写出“图上读数=xx”（避免文本捷径）
* ✅ 允许写出“判据/阈值/公式/单位换算规则”（来自参考信息改写）

可以在 Stage2/3/Final 的 prompt 中加一句：

```text
去词汇化只针对“图上读数/视觉结果”，不限制写入中性判据(阈值/公式/单位换算)。
```

---

## 2) 第二部分：让 fact_hint 真正适合做“计算/分支题”（改 facts 抽取）

你现在 `facts.py` 抽取是“关键事实”，但没强调“可计算/可判级”。要改成偏“判据型事实”。

建议改 `build_fact_extraction_prompt`：

```diff
- 你需要从下述文档中抽取最多 {max_facts} 条可用于出题的关键事实。
+ 你需要从下述文档中抽取最多 {max_facts} 条“可用于条件计算/分支判定”的关键事实。
  要求:
- - 每条事实简洁明确，便于出题与验证。
+ - 优先抽取：阈值/公式/单位换算/表格数值/分级规则/判定条件（能写成“若…则…”或“按…计算…”）。
+ - 避免抽取：纯定义/背景描述/无法落地计算的陈述。
  - 标注出处的行号区间，例如 "L12-L18"。
- - 只输出 JSON 数组
+ - 输出 JSON 数组，并给出类型 kind: "threshold|formula|rule|table|other"
```

输出结构变成：

```json
[{"fact":"...","source":"L12-L18","kind":"threshold"}, ...]
```

这会显著提升后续“落地成题干条件”的成功率。

---

## 3) 第三部分：operate_calculation 草稿要产出“可直接落题的四选项”，并要求 Stage2/3 必须跟随

你现在 `operate_calculation.py` 已经很接近了，但有两点要加强：

### 3.1 草稿必须输出“题干条件文本模板”

在 `<draft>` 里加一项，让它输出“可直接贴进题干的中性条件（不含来源）”：

```diff
4) 选项：A-D 候选...
+5) 题干条件(可直接写入题干，不提来源)：给出1-2句中性条件/判据/公式文本
```

### 3.2 在 Stage2/3 prompt 里要求“必须采用草稿的题干条件”

在 `build_stage2_step_prompt/build_stage3_step_prompt/build_extend_step_prompt` 里加硬约束：

```text
- 你必须在题干中写入 operate_calculation 草稿中的“题干条件”句子（可微调措辞但保留判据/公式/阈值）。
```

否则草稿再好，出题模型也会“偷懒不用”。

---

## 4) 第四部分：把“难度”变成程序硬门槛（不是指望模型自觉）

你现在只有 prompt，没有看到“硬拒绝+重写”的执行逻辑文件（你也说 README 是流程，其他是 prompt）。
所以你需要在 `run_episode / main loop` 里加三个 **硬门槛** ：

### 4.1 结构门槛：必须满足 multi-hop & cross-modal 可验证

对每个 step / final 做自动检查（用简单正则就够）：

* 是否包含 4 个选项 A-D
* final 是否包含  **≥2 条“中性条件”** （可以用数字/单位/“若…则…”/“按…计算…”等模式检测）
* 是否是“数值/区间/等级型选项”（至少 3 个选项含数字/区间符号）
* 是否包含图像锚点词（如“左上/右侧/箭头/标注/曲线/表格/仪表盘/刻度”等）

不满足 →  **直接 revise 或丢弃** ，不要进入求解器环节浪费次数。

### 4.2 捷径门槛：Text-only 能做对就一票否决

你已经有 `build_solver_prompt_text_only()`，把它用起来：

* `text_only_solver` 若输出=标准答案
  → 说明题干存在文本捷径（不用看图也能做）
  →  **必须 revise/harden** （把“关键变量”搬回图上，只在图里能读到）

### 4.3 难度门槛：Medium 任意一次做对 → 直接判“太简单”

务必做到：

* Medium：temperature=0，跑  1 次
* **只要有一次做对，就判 easy** （保守过滤）
* easy → 触发 “analysis feedback → harden 重写” 闭环，而不是保存

---

## 5) 第五部分：加一个“强制加难重写 Prompt”（你 README 里提到但现在缺）

新增一个 harden prompt（可以新建 `harden.py` 或塞进 `final.py`），用途是：当检测 easy 时，强制把题改成“二步计算/分支+单位陷阱+误读陷阱”的版本。

建议 harden prompt 核心指令（要非常硬）：

* 必须新增一个中间变量（先算再判）
* 必须增加一个分支规则（先从图判分支）
* 选项必须来自 3 条错误路径：单位错 / 读图错 / 条件错
* 必须写入 2 条中性判据（来自 fact_hint/evidence 改写）

---

## 6) 给你一个“落地顺序”（按收益从大到小）

1. **先改 steps.py + final.py 的“参考信息禁止入题干”** → 改成“允许中性条件入题干”
2. **facts.py 抽取改成 threshold/formula/rule 优先**
3. **加 text-only 一票否决**
4. **Medium 多次采样：任意一次做对就 reject**
5. **加 harden 重写 prompt + 闭环**
6. 最后再微调“去词汇化/干扰项同质性”等细节
